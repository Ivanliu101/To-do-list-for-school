<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Homework To-Do âœ¦</title>
    <style>
        :root{
            --bg:#f6f8fb; --card:#ffffff; --muted:#777; --accent:#2b6bf6;
            --yellow:#fff7b2;
        }
        *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
        body{margin:0;background:var(--bg);color:#111;padding:20px}
        header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
        h1{margin:0;font-size:20px}
        .sub{color:var(--muted);font-size:13px}
        .layout{display:flex;gap:18px}
        .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 4px 18px rgba(20,30,60,0.06)}
        .left{width:320px}
        .right{flex:1;min-width:320px}
        label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
        input[type="text"], select, input[type="date"]{
            width:100%;padding:8px;border-radius:8px;border:1px solid #e3e7ef;background:#fff;
        }
        button{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
        .small{font-size:13px;padding:6px 8px}
        .task-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
        .task{
            padding:10px;border-radius:8px;border:1px solid #eee;display:flex;gap:10px;align-items:flex-start;
            background:#fff;position:relative;
        }
        .task.late{background:var(--yellow);border-color:#f2df5b}
        .task .title{font-weight:600}
        .meta{font-size:12px;color:var(--muted);margin-top:6px}
        .badges{display:flex;gap:6px;flex-wrap:wrap}
        .badge{font-size:11px;padding:4px 6px;border-radius:999px;background:#f0f4ff;color:#133; border:1px solid #e6eefc}
        .badge.priority-high{background:#ffe8e8;border-color:#ffd0d0;color:#a00}
        .actions{margin-left:auto;display:flex;gap:6px}
        .btn-ghost{background:transparent;border:1px solid #e6e9ef;padding:6px;border-radius:8px;cursor:pointer}
        .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .import-box{
            position:fixed;left:12px;bottom:12px;width:180px;height:96px;border-radius:10px;
            background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 6px 30px rgba(10,30,80,0.08);
            border:2px dashed #cfe3ff;display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;
            font-size:13px;color:#2153c9;cursor:pointer;z-index:999;
        }
        .import-box.dragover{background:#eaf3ff;border-color:#2b6bf6}
        .top-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .empty{color:var(--muted);padding:12px;text-align:center}
        .row{display:flex;gap:8px;align-items:center}
        .category-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
        .category-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px}
        .small-muted{font-size:12px;color:var(--muted)}
        .due-pill{font-size:12px;padding:4px 6px;border-radius:6px;background:#fafafa;border:1px solid #eee}
        .completed{opacity:0.5;text-decoration:line-through}
        footer{margin-top:14px;color:var(--muted);font-size:13px}
        @media(max-width:880px){.layout{flex-direction:column}.left{width:100%}}
    </style>
</head>
<body>
<header>
    <div>
        <h1>Homework To-Do âœ¦</h1>
        <div class="sub">åˆ†é¡ï¼å„ªå…ˆï¼ç¹³äº¤æ™‚é–“ â€” é²äº¤è‡ªå‹•æµ®ä¸Šä¸¦ä»¥é»ƒè‰²æ¨™ç¤º ğŸŸ¡</div>
    </div>
</header>

<div class="layout">
    <div class="panel left">
        <div><strong>æ–°å¢ä»»å‹™ âœ¦</strong></div>
        <div style="margin-top:8px">
            <label>æ¨™é¡Œ</label>
            <input id="title" type="text" placeholder="è¼¸å…¥ä½œæ¥­æ¨™é¡Œ..." />
        </div>
        <div style="margin-top:8px">
            <label>åˆ†é¡</label>
            <select id="categorySelect"></select>
            <div style="display:flex;gap:6px;margin-top:6px">
                <input id="newCategory" type="text" placeholder="æ–°å¢åˆ†é¡..." />
                <button id="addCat" class="small">åŠ å…¥</button>
            </div>
        </div>
        <div style="margin-top:8px">
            <label>å„ªå…ˆç­‰ç´š</label>
            <select id="priority">
                <option value="2">High</option>
                <option value="1">Medium</option>
                <option value="0">Low</option>
            </select>
        </div>
        <div style="margin-top:8px">
            <label>ç¹³äº¤æ™‚é–“</label>
            <input id="dueDate" type="date" />
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
            <button id="addTask">æ–°å¢ä»»å‹™</button>
            <button id="exportBtn" class="btn-ghost">åŒ¯å‡ºæª”æ¡ˆ</button>
            <button id="clearAll" class="btn-ghost">æ¸…ç©º</button>
        </div>

        <div style="margin-top:14px">
            <div class="small-muted">ç¯©é¸</div>
            <div class="filters" id="filters">
                <select id="filterCategory"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
                <select id="filterStatus">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="pending">æœªå®Œæˆ</option>
                    <option value="completed">å·²å®Œæˆ</option>
                </select>
                <select id="filterPriority">
                    <option value="">æ‰€æœ‰å„ªå…ˆ</option>
                    <option value="2">High</option>
                    <option value="1">Medium</option>
                    <option value="0">Low</option>
                </select>
            </div>
        </div>

        <div class="category-list" id="categoryList" style="margin-top:12px">
            <div><strong>åˆ†é¡åˆ—è¡¨</strong></div>
            <!-- categories -->
        </div>

        <footer>
            <div>æª”æ¡ˆèªªæ˜ï¼šæŒ‰ã€ŒåŒ¯å‡ºæª”æ¡ˆã€æœƒå­˜æˆ JSON æª”ï¼Œä¹‹å¾Œåœ¨å…¶ä»–é›»è…¦æŠŠæª”æ¡ˆæ‹–åˆ°å·¦ä¸‹è§’çš„åŒ¯å…¥æ ¼å­å³å¯è¼‰å…¥è³‡æ–™ã€‚</div>
        </footer>
    </div>

    <div class="panel right">
        <div class="top-controls">
            <div><strong>ä»»å‹™æ¸…å–®</strong></div>
            <div class="small-muted">ï¼ˆè‡ªå‹•æŠŠéæœŸæœªå®Œæˆç§»åˆ°æœ€ä¸Šæ–¹ï¼‰</div>
            <div style="margin-left:auto" class="row">
                <div class="small-muted">é¡¯ç¤ºå®Œæˆ</div>
                <input id="showCompleted" type="checkbox" checked style="margin-left:6px" />
            </div>
        </div>

        <div id="taskContainer" class="task-list" style="margin-top:12px"></div>
    </div>
</div>

<div id="importBox" class="import-box" title="æ‹–æ”¾æª”æ¡ˆåˆ°é€™è£¡æˆ–é»æ“Šé¸æ“‡">
    <div>
        <div style="font-weight:700">åŒ¯å…¥æª”æ¡ˆ</div>
        <div style="font-size:12px;margin-top:6px">æŠŠ .json æª”æ‹–åˆ°é€™è£¡æˆ–é»æ“Šé¸æª”</div>
        <input id="fileInput" type="file" accept=".json" style="display:none" />
    </div>
</div>

<script>
    /* ====== è³‡æ–™æ¨¡å‹ ======
    task = {
      id, title, category, priority(2/1/0), dueDate (YYYY-MM-DD or ""), completed:boolean, created:timestamp
    }
    */
    const DEFAULT_CATS = ['æ•¸å­¸','åœ‹æ–‡','è‹±æ–‡','è‡ªç„¶','ç¤¾æœƒ','å°ˆé¡Œ'];

    let tasks = [];
    let categories = [...DEFAULT_CATS];

    const el = (id)=>document.getElementById(id);

    // åˆå§‹åŒ– UI
    function init(){
// è³‡æ–™ï¼šå…ˆå˜—è©¦å¾ localStorage è®€å–ï¼ˆæ–¹ä¾¿åŒä¸€å°é›»è…¦ï¼‰ï¼Œå¦å‰‡è¼‰å…¥ä¸€äº›ç¯„ä¾‹
        const local = localStorage.getItem('hw_tasks_v1');
        const localCats = localStorage.getItem('hw_cats_v1');
        if(local){
            try{ tasks = JSON.parse(local) }catch(e){}
        } else {
            // ç¯„ä¾‹è³‡æ–™
            tasks = [
                {id: genId(), title:"æ•¸å­¸ç¿’é¡Œï¼šç¬¬5-8é¡Œ", category:"æ•¸å­¸", priority:2, dueDate: nextDay(-1), completed:false, created:Date.now()},
                {id: genId(), title:"è‹±æ–‡ä½œæ–‡ï¼šMy Summer", category:"è‹±æ–‡", priority:1, dueDate: nextDay(2), completed:false, created:Date.now()},
                {id: genId(), title:"è‡ªç„¶å ±å‘Šè‰ç¨¿", category:"è‡ªç„¶", priority:0, dueDate: nextDay(0), completed:false, created:Date.now()},
                {id: genId(), title:"æ­·å²è®€æ›¸ï¼šç¬¬ä¸‰ç« ", category:"ç¤¾æœƒ", priority:1, dueDate: '', completed:false, created:Date.now()},
            ];
        }
        if(localCats) {
            try{ categories = JSON.parse(localCats) }catch(e){}
        }
        bindUI();
        renderCategories();
        renderTasks();
        startTimerForOverdue();
    }

    function genId(){ return 't'+Math.random().toString(36).slice(2,9) }
    function nextDay(offset){
        const d = new Date(); d.setDate(d.getDate() + offset);
        return d.toISOString().slice(0,10);
    }

    /* ====== UI ç¶å®š ====== */
    function bindUI(){
        el('addCat').addEventListener('click', ()=>{
            const val = el('newCategory').value.trim();
            if(!val) return;
            if(!categories.includes(val)) categories.push(val);
            el('newCategory').value = '';
            saveCats();
            renderCategories();
        });

        el('addTask').addEventListener('click', ()=>{
            const title = el('title').value.trim();
            if(!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
            const category = el('categorySelect').value || categories[0] || 'å…¶ä»–';
            const priority = Number(el('priority').value);
            const due = el('dueDate').value || '';
            tasks.push({id:genId(), title, category, priority, dueDate:due, completed:false, created:Date.now()});
            el('title').value=''; el('dueDate').value='';
            saveTasks();
            renderTasks();
        });

        el('exportBtn').addEventListener('click', exportFile);
        el('clearAll').addEventListener('click', ()=>{
            if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä»»å‹™å—ï¼Ÿ')) return;
            tasks = [];
            saveTasks();
            renderTasks();
        });

        el('filterCategory').addEventListener('change', renderTasks);
        el('filterStatus').addEventListener('change', renderTasks);
        el('filterPriority').addEventListener('change', renderTasks);
        el('showCompleted').addEventListener('change', renderTasks);

// åŒ¯å…¥å€ (æ‹–æ”¾ & é»æ“Š)
        const box = el('importBox');
        const fileIn = el('fileInput');

        box.addEventListener('click', ()=>fileIn.click());
        fileIn.addEventListener('change',(e)=>{
            if(e.target.files.length) handleFile(e.target.files[0]);
            e.target.value='';
        });

        ['dragenter','dragover'].forEach(ev=>{
            box.addEventListener(ev,(e)=>{ e.preventDefault(); box.classList.add('dragover'); });
        });
        ['dragleave','drop'].forEach(ev=>{
            box.addEventListener(ev,(e)=>{
                e.preventDefault(); box.classList.remove('dragover');
                if(ev==='drop'){
                    const files = e.dataTransfer.files;
                    if(files.length) handleFile(files[0]);
                }
            });
        });

// é¡åˆ¥é»æ“Šåˆªé™¤
        el('categoryList').addEventListener('click', (e)=>{
            if(e.target.dataset.action === 'delcat'){
                const cat = e.target.dataset.cat;
                if(!confirm(`åˆªé™¤åˆ†é¡ã€Œ${cat}ã€ï¼Ÿï¼ˆä¸æœƒåˆªé™¤è©²åˆ†é¡ä¸‹çš„ä»»å‹™ï¼‰`)) return;
                categories = categories.filter(c=>c!==cat);
                saveCats(); renderCategories(); renderTasks();
            }
        });
    }

    /* ====== å­˜å– ====== */
    function saveTasks(){
        localStorage.setItem('hw_tasks_v1', JSON.stringify(tasks));
    }

    function saveCats(){
        localStorage.setItem('hw_cats_v1', JSON.stringify(categories));
    }

    /* åŒ¯å‡ºæª”æ¡ˆï¼ˆä¸‹è¼‰ JSONï¼‰ */
    function exportFile(){
        const payload = {version:1, exportedAt:new Date().toISOString(), categories, tasks};
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `homework_tasks_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
    }

    /* åŒ¯å…¥æª”æ¡ˆï¼ˆè¦†è“‹æˆ–åˆä½µï¼‰ */
    function handleFile(file){
        if(!file.name.endsWith('.json')) { alert('è«‹ä¸Šå‚³ JSON æª”'); return; }
        const reader = new FileReader();
        reader.onload = (e)=>{
            try{
                const payload = JSON.parse(e.target.result);
                if(payload && payload.tasks){
                    if(confirm('è¦å°‡åŒ¯å…¥æª”æ¡ˆã€Œè¦†è“‹ã€ç›®å‰è³‡æ–™å—ï¼Ÿï¼ˆæŒ‰ã€Œå–æ¶ˆã€å‰‡æœƒåˆä½µï¼‰')){
                        tasks = payload.tasks || [];
                        categories = payload.categories || categories;
                    } else {
// åˆä½µï¼šé¿å… id è¡çª
                        const existingIds = new Set(tasks.map(t=>t.id));
                        for(const t of (payload.tasks||[])){
                            let newid = t.id;
                            while(existingIds.has(newid)) newid = genId();
                            t.id = newid;
                            tasks.push(t);
                            existingIds.add(newid);
                        }
                        if(payload.categories) {
                            for(const c of payload.categories){ if(!categories.includes(c)) categories.push(c) }
                        }
                    }
                    saveTasks(); saveCats(); renderCategories(); renderTasks();
                    alert('è¼‰å…¥æˆåŠŸ âœ”');
                } else {
                    alert('JSON æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼ˆæ‰¾ä¸åˆ° tasksï¼‰');
                }
            }catch(err){
                console.error(err);
                alert('ç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„ JSON');
            }
        };
        reader.readAsText(file);
    }

    /* ====== æ¸²æŸ“ ====== */
    function renderCategories(){
        const sel = el('categorySelect');
        sel.innerHTML = '';
        for(const c of categories){
            const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt);
        }
        const fc = el('filterCategory');
        fc.innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>';
        for(const c of categories){
            const opt = document.createElement('option'); opt.value=c; opt.textContent=c; fc.appendChild(opt);
        }

        const list = el('categoryList');
        list.innerHTML = '<div><strong>åˆ†é¡åˆ—è¡¨</strong></div>';
        for(const c of categories){
            const row = document.createElement('div'); row.className='category-item';
            row.innerHTML = `<div>${c}</div><div><button data-action="delcat" data-cat="${c}" class="btn-ghost small">åˆªé™¤</button></div>`;
            list.appendChild(row);
        }
    }

    /* åˆ¤æ–·æ˜¯å¦éæœŸï¼ˆé²äº¤ï¼‰*/
    function isLate(task){
        if(task.completed) return false;
        if(!task.dueDate) return false;
        const today = new Date().toISOString().slice(0,10);
        return today > task.dueDate;
    }

    /* æ’åºï¼šå…ˆæŠŠéæœŸæœªå®Œæˆæ”¾æœ€ä¸Šï¼ˆæŒ‰ç…§æœ€ä¹…éæœŸå…ˆï¼‰ï¼Œå†ä¾å„ªå…ˆåº¦(2>1>0)ï¼Œå†ç¹³äº¤æ™‚é–“(è¶Šè¿‘å…ˆ)ï¼Œæœ€å¾Œå»ºç«‹æ™‚é–“ */
    function sortedTasks(){
        const copy = [...tasks];
        copy.sort((a,b)=>{
            const aLate = isLate(a) ? 1 : 0;
            const bLate = isLate(b) ? 1 : 0;
            if(aLate !== bLate) return bLate - aLate; // late first (bLate=1 => b before a)
            if(aLate && bLate){
// å…©è€…éƒ½æ˜¯éæœŸï¼šä¾ç…§éæœŸè¶Šä¹…å…ˆï¼ˆè¼ƒæ—© dueDate å…ˆï¼‰
                if(a.dueDate && b.dueDate){
                    if(a.dueDate !== b.dueDate) return a.dueDate.localeCompare(b.dueDate);
                }
            }
// æœªéæœŸæˆ–åŒç‹€æ…‹ï¼šä¾å„ªå…ˆåº¦ desc
            if(a.priority !== b.priority) return b.priority - a.priority;
// å†ä¾ç…§åˆ°æœŸæ—¥ï¼ˆç„¡åˆ°æœŸæ—¥æ’å¾Œé¢ï¼‰
            if(a.dueDate && b.dueDate){
                if(a.dueDate !== b.dueDate) return a.dueDate.localeCompare(b.dueDate);
            } else if(a.dueDate && !b.dueDate) return -1;
            else if(!a.dueDate && b.dueDate) return 1;
// æœ€å¾Œå»ºç«‹æ™‚é–“
            return a.created - b.created;
        });
        return copy;
    }

    function renderTasks(){
        const container = el('taskContainer');
        container.innerHTML = '';
        const fc = el('filterCategory').value;
        const fs = el('filterStatus').value;
        const fp = el('filterPriority').value;
        const showCompleted = el('showCompleted').checked;

        const arr = sortedTasks().filter(t=>{
            if(fc && t.category !== fc) return false;
            if(fp !== '' && String(t.priority) !== String(fp)) return false;
            if(fs === 'pending' && t.completed) return false;
            if(fs === 'completed' && !t.completed) return false;
            if(!showCompleted && t.completed) return false;
            return true;
        });

        if(arr.length === 0){
            container.innerHTML = `<div class="empty">ç›®å‰æ²’æœ‰ä»»å‹™ âœ¨</div>`;
            return;
        }

        for(const t of arr){
            const wrap = document.createElement('div');
            wrap.className = 'task' + (isLate(t) ? ' late' : '');
            const left = document.createElement('div'); left.style.flex='1';
            left.innerHTML = `<div class="title ${t.completed ? 'completed' : ''}">${escapeHtml(t.title)}</div>
<div class="meta">
<span class="badges">
<span class="badge">${escapeHtml(t.category)}</span>
<span class="badge priority-${t.priority===2 ? 'high' : (t.priority===1 ? 'med' : 'low')}">Priority: ${t.priority===2? 'High': t.priority===1? 'Medium': 'Low'}</span>
</span>
<span style="float:right" class="due-pill">${t.dueDate? 'ç¹³äº¤ï¼š'+t.dueDate : 'ç„¡æœŸé™'}</span>
</div>`;
            wrap.appendChild(left);

            const actions = document.createElement('div'); actions.className='actions';
            const chk = document.createElement('button'); chk.className='btn-ghost small'; chk.textContent = t.completed ? 'æœªå®Œæˆ' : 'å®Œæˆ';
            chk.addEventListener('click', ()=>{ t.completed = !t.completed; saveTasks(); renderTasks(); });
            const edit = document.createElement('button'); edit.className='btn-ghost small'; edit.textContent='ç·¨è¼¯';
            edit.addEventListener('click', ()=>openEditor(t));
            const del = document.createElement('button'); del.className='btn-ghost small'; del.textContent='åˆªé™¤';
            del.addEventListener('click', ()=>{ if(confirm('åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')){ tasks = tasks.filter(x=>x.id!==t.id); saveTasks(); renderTasks(); }});
            actions.appendChild(chk); actions.appendChild(edit); actions.appendChild(del);
            wrap.appendChild(actions);
            container.appendChild(wrap);
        }
    }

    /* ç·¨è¼¯å½ˆçª—ï¼ˆç°¡æ˜“ prompt é¢¨æ ¼ï¼‰ */
    function openEditor(task){
        const newTitle = prompt('ç·¨è¼¯æ¨™é¡Œ', task.title);
        if(newTitle === null) return;
        task.title = newTitle.trim() || task.title;

        const newCat = prompt('åˆ†é¡', task.category) || task.category;
        if(!categories.includes(newCat)) categories.push(newCat);
        task.category = newCat;

        const newPri = prompt('å„ªå…ˆï¼ˆ2=High,1=Medium,0=Lowï¼‰', String(task.priority));
        if(newPri !== null && ['0','1','2'].includes(String(newPri).trim())) task.priority = Number(newPri);

        const newDue = prompt('ç¹³äº¤æ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºè¡¨ç¤ºç„¡æœŸé™)', task.dueDate||'') || '';
        if(newDue && !/^\d{4}-\d{2}-\d{2}$/.test(newDue)) { alert('æ—¥æœŸæ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€ç‚º YYYY-MM-DD'); }
        else task.dueDate = newDue;
        saveCats(); saveTasks(); renderCategories(); renderTasks();
    }

    /* æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡éæœŸç‹€æ…‹ï¼ˆè®“é²äº¤èƒ½å³æ™‚è·‘ä¸Šä¾†ï¼‰ */
    let overdueTimer = null;
    function startTimerForOverdue(){
        if(overdueTimer) clearInterval(overdueTimer);
        overdueTimer = setInterval(()=>{ renderTasks(); }, 60*1000);
    }

    /* å°å·¥å…· */
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    /* å•Ÿå‹• */
    init();
</script>
</body>
</html>